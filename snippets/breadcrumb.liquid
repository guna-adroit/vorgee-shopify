{% comment %} <style>
    {% if template.name == 'collection' or template.name == 'list-collections' %}
        .breadcrumb-container{
            display: none;
        }
    {% endif %}
  .breadcrumb-container{
  }
  .breadcrumbs {
    padding-top: 50px;
    padding-bottom: 50px;
    color: #121212;
  }
  .breadcrumbs__list{
    /* display: flex; */
    /* gap: 10px; */
  }
  .breadcrumbs__item, .breadcrumbs__link, .breadcrumbs__item.collection a{
    font-weight: 300;
    font-size: 16px;
    line-height: 150%;
    color: #121212;
  }
  .breadcrumbs__link.home, .breadcrumbs__item.collection{
    font-weight: 300;
  }
  .breadcrumbs__link.home:hover{
    color: inherit;
  }
  .breadcrumbs__list {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .breadcrumbs__item {
    display: inline-block;
  }

  .breadcrumbs__link[aria-current="page"] {
    color: inherit;
    font-weight: 300;
    text-decoration: none;
  }

  .breadcrumbs__link[aria-current="page"]:hover,
  .breadcrumbs__link[aria-current="page"]:focus {
    text-decoration: underline;
  }
  @media screen and (max-width: 820px){
    .breadcrumbs {
      padding-top: 20px;
      padding-bottom: 20px;
    }
    .breadcrumbs__item, .breadcrumbs__link, .breadcrumbs__item.collection a{
    font-size: 14px;
  }
  }
</style>

{%- unless template == 'index' or template == 'list-collections' or template == '404' -%}
{%- assign t = template | split: '.' | first -%}
<div class="breadcrumb-container section section--page-width">
<nav class="breadcrumbs page-width" role="navigation" aria-label="breadcrumbs">
  <div class="breadcrumbs__list">
    <span class="breadcrumbs__item">
      <a class="breadcrumbs__link home" href="{{ routes.root_url }}">Home</a>
    </span>
    <span>/ </span>
    {%- case t -%}
      {%- when 'page' -%}
        <span class="breadcrumbs__item">
          <a class="breadcrumbs__link" href="{{ page.url }}" aria-current="page"> {{ page.title }}</a>
        </span>
      {%- when 'product' -%}
        {%- if collection and collection.title != blank -%}
          <span class="breadcrumbs__item collection">
            <a class="breadcrumbs__link" href="{{ collection.url }}">{{ collection.title }}</a>
          </span>
          <span>/ </span>
        {%- endif -%}
        <span class="breadcrumbs__item">
          <a class="breadcrumbs__link" href="{{ product.url }}" aria-current="page">{{ product.title }}</a>
        </span>
        {%- if collection.url -%}
          <span class="breadcrumbs__item collection">
            {{ collection.title | link_to: collection.url }}
          </span>
          <span>/ </span>
        {%- endif -%}
        <span class="breadcrumbs__item">
          <a class="breadcrumbs__link" href="{{ product.url }}" aria-current="page"> {{ product.title }}</a>
        </span>
      {%- when 'collection' and collection.handle -%}
        {%- if current_tags -%}
          <span class="breadcrumbs__item">
             {{ collection.title | link_to: collection.url }}
          </span>
          <span class="breadcrumbs__item">
            {%- capture tag_url -%}{{ collection.url }}/{{ current_tags | join: "+"}}{%- endcapture -%}
            <a class="breadcrumbs__link" href="{{ tag_url }}" aria-current="page"> {{ current_tags | join: " + "}}</a>
          </span>
        {%- else -%}
          <span class="breadcrumbs__item">
            <a class="breadcrumbs__link" href="{{ collection.url }}" aria-current="page"> {{ collection.title }}</a>
          </span>
        {%- endif -%}
      {%- when 'blog' -%}
        {%- if current_tags -%}
          <span class="breadcrumbs__item">
            {{ blog.title | link_to: blog.url }}
          </span>
          <span class="breadcrumbs__item">
            {%- capture tag_url -%}{{blog.url}}/tagged/{{ current_tags | join: "+" }}{%- endcapture -%}
            <a class="breadcrumbs__link" href="{{ tag_url }}" aria-current="page"> {{ current_tags | join: " + " }}</a>
          </span>
        {%- else -%}
          <span class="breadcrumbs__item">
            <a class="breadcrumbs__link" href="{{ blog.url }}" aria-current="page"> {{ blog.title }}</a>
          </span>
        {%- endif -%}
      {%- when 'article' -%}
        <span class="breadcrumbs__item">
          {{ blog.title | link_to: blog.url }}
        </span>
        <span class="breadcrumbs__item">
          <a class="breadcrumbs__link" href="{{ article.url }}" aria-current="page"> {{ article.title }}</a>
        </span>
      
      {%- else -%}
        {% if template.name == 'addresses' %}
          <span class="breadcrumbs__item">
            <a class="breadcrumbs__link" href="{{ routes.account_url }}" aria-current="page"> Account</a>
          </span>
        {% else %}
        <span class="breadcrumbs__item">
          <a class="breadcrumbs__link" href="{{ request.path }}" aria-current="page"> {{ page_title }}</a>
        </span>
      {% endif %}
    {%- endcase -%}
  </div>
</nav>
</div>
{%- endunless -%} {% endcomment %}

{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-breadcrumb-{{ ai_gen_id }} {
    padding: {{ block.settings.padding_vertical }}px {{ block.settings.padding_horizontal }}px;
    background-color: {{ block.settings.background_color }};
    border-bottom: {{ block.settings.border_width }}px solid {{ block.settings.border_color }};
  }

  .ai-breadcrumb-nav-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: {{ block.settings.spacing }}px;
    font-size: {{ block.settings.font_size }}px;
    line-height: 1.4;
  }

  .ai-breadcrumb-item-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    gap: {{ block.settings.spacing }}px;
  }

  .ai-breadcrumb-link-{{ ai_gen_id }} {
    color: {{ block.settings.link_color }};
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .ai-breadcrumb-link-{{ ai_gen_id }}:hover {
    color: {{ block.settings.link_hover_color }};
    text-decoration: underline;
  }

  .ai-breadcrumb-current-{{ ai_gen_id }} {
    color: {{ block.settings.current_color }};
    font-weight: {{ block.settings.current_font_weight }};
  }

  .ai-breadcrumb-separator-{{ ai_gen_id }} {
    color: {{ block.settings.separator_color }};
    font-size: {{ block.settings.font_size | times: 0.9 }}px;
    user-select: none;
  }

  @media screen and (max-width: 749px) {
    .ai-breadcrumb-{{ ai_gen_id }} {
      padding: {{ block.settings.padding_vertical | times: 0.75 }}px {{ block.settings.padding_horizontal | times: 0.75 }}px;
    }

    .ai-breadcrumb-nav-{{ ai_gen_id }} {
      font-size: {{ block.settings.font_size | times: 0.9 }}px;
      gap: {{ block.settings.spacing | times: 0.8 }}px;
    }

    .ai-breadcrumb-item-{{ ai_gen_id }} {
      gap: {{ block.settings.spacing | times: 0.8 }}px;
    }
  }
{% endstyle %}

<breadcrumb-navigation-{{ ai_gen_id }}
  class="ai-breadcrumb-{{ ai_gen_id }}"
  data-current-url="{{ request.url }}"
  {{ block.shopify_attributes }}
>
  <nav class="ai-breadcrumb-nav-{{ ai_gen_id }}" aria-label="Breadcrumb navigation">
    <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
      <a href="{{ routes.root_url }}" class="ai-breadcrumb-link-{{ ai_gen_id }}">
        {{ block.settings.home_text }}
      </a>
    </div>

    {% liquid
      assign referrer_collection = null
      assign current_collection = null
      
      if request.headers['Referer'] and request.headers['Referer'] contains shop.permanent_domain
        assign referer_url = request.headers['Referer']
        assign referer_path = referer_url | split: shop.permanent_domain | last | split: '?' | first
        
        if referer_path contains '/collections/'
          assign collection_handle = referer_path | split: '/collections/' | last | split: '/' | first
          assign referrer_collection = collections[collection_handle]
        endif
      endif
      
      if referrer_collection
        assign current_collection = referrer_collection
      elsif collection
        assign current_collection = collection
      elsif product and product.collections.size > 0
        assign current_collection = product.collections.first
      endif
    %}

    {% if current_collection %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <a href="{{ current_collection.url }}" class="ai-breadcrumb-link-{{ ai_gen_id }}">
          {{ current_collection.title }}
        </a>
      </div>
    {% endif %}

    {% if product %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <span class="ai-breadcrumb-current-{{ ai_gen_id }}" aria-current="page">
          {{ product.title }}
        </span>
      </div>
    {% elsif collection %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <span class="ai-breadcrumb-current-{{ ai_gen_id }}" aria-current="page">
          {{ collection.title }}
        </span>
      </div>
    {% elsif page %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <span class="ai-breadcrumb-current-{{ ai_gen_id }}" aria-current="page">
          {{ page.title }}
        </span>
      </div>
    {% elsif blog %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <span class="ai-breadcrumb-current-{{ ai_gen_id }}" aria-current="page">
          {{ blog.title }}
        </span>
      </div>
    {% elsif article %}
      {% if blog %}
        <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
          {{ block.settings.separator }}
        </span>
        <div class="ai-breadcrumb-item-{{ ai_gen_id }}"><a href="{{ blog.url }}" class="ai-breadcrumb-link-{{ ai_gen_id }}">
            {{ blog.title }}
          </a>
        </div>
      {% endif %}
      <span class="ai-breadcrumb-separator-{{ ai_gen_id }}" aria-hidden="true">
        {{ block.settings.separator }}
      </span>
      <div class="ai-breadcrumb-item-{{ ai_gen_id }}">
        <span class="ai-breadcrumb-current-{{ ai_gen_id }}" aria-current="page">
          {{ article.title }}
        </span>
      </div>
    {% endif %}
  </nav>
</breadcrumb-navigation-{{ ai_gen_id }}>

<script>
  (function() {
    class BreadcrumbNavigation{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
      }

      connectedCallback() {
        this.enhanceAccessibility();
        this.trackAndUpdateBreadcrumb();
      }

      enhanceAccessibility() {
        const links = this.querySelectorAll('.ai-breadcrumb-link-{{ ai_gen_id }}');
        links.forEach((link, index) => {
          if (index === 0) {
            link.setAttribute('aria-label', 'Go to homepage');
          } else {
            const text = link.textContent.trim();
            link.setAttribute('aria-label', `Go to ${text}`);
          }
        });
      }

      trackAndUpdateBreadcrumb() {
        if (typeof sessionStorage === 'undefined') return;

        try {
          const currentUrl = window.location.href;
          const currentPath = window.location.pathname;
          const referrer = document.referrer;
          
          if (referrer && referrer.includes(window.location.hostname)) {
            const referrerPath = new URL(referrer).pathname;
            
            if (referrerPath.includes('/collections/') && currentPath.includes('/products/')) {
              const collectionHandle = referrerPath.split('/collections/')[1].split('/')[0].split('?')[0];
              
              sessionStorage.setItem('breadcrumb_collection_context', JSON.stringify({
                handle: collectionHandle,
                referrer: referrer,
                timestamp: Date.now()
              }));
              
              this.updateCollectionBreadcrumb(collectionHandle);
            }
          }
          
          const storedContext = sessionStorage.getItem('breadcrumb_collection_context');
          if (storedContext && currentPath.includes('/products/')) {
            const context = JSON.parse(storedContext);
            const timeDiff = Date.now() - context.timestamp;
            
            if (timeDiff < 300000) {
              this.updateCollectionBreadcrumb(context.handle);
            } else {
              sessionStorage.removeItem('breadcrumb_collection_context');
            }
          }
          
        } catch (e) {
          console.warn('Unable to track breadcrumb context:', e);
        }
      }

      updateCollectionBreadcrumb(collectionHandle) {
        if (!collectionHandle) return;

        fetch(`/collections/${collectionHandle}.json`)
          .then(response => response.json())
          .then(data => {
            const collectionLink = this.querySelector('.ai-breadcrumb-link-{{ ai_gen_id }}[href*="/collections/"]');
            if (collectionLink && data.collection) {
              collectionLink.textContent = data.collection.title;
              collectionLink.href = `/collections/${collectionHandle}`;
              collectionLink.setAttribute('aria-label', `Go to ${data.collection.title}`);
            }
          })
          .catch(e => {
            console.warn('Unable to fetch collection data:', e);
          });
      }
    }

    customElements.define('breadcrumb-navigation-{{ ai_gen_id }}', BreadcrumbNavigation{{ ai_gen_id }});
  })();
</script>